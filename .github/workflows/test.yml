name: Test

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Lint"]
    types:
      - completed
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: read

jobs:
  # Only run if lint passed or if manually triggered
  check-lint-status:
    name: Check Lint Status
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Check if tests should run
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: check-lint-status
    if: needs.check-lint-status.outputs.should-run == 'true'
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Mise
        uses: jdx/mise-action@v2
      - name: Install Dependencies
        run: mise x -- pnpm install
      - name: Run Tests
        run: mise x -- pnpm test
      - name: Upload Coverage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          retention-days: 1
          if-no-files-found: error
          path: |
            apps/web/coverage/lcov.info
            apps/web/coverage-summary.json
            apps/web/coverage.json

            packages/ui/coverage/lcov.info
            packages/ui/coverage-summary.json
            packages/ui/coverage.json

  report-coverage-in-pr:
    name: Report Coverage in PR
    runs-on: ubuntu-latest
    needs: test
    if: always() && needs.test.result != 'skipped'
    permissions:
      pull-requests: write
    strategy:
      matrix:
        app:
          - name: Web
            directory: apps/web
          - name: "@repo/ui"
            directory: packages/ui
    steps:
      - uses: actions/checkout@v5
      - name: Download Coverage Artifacts
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
      - name: Report Coverage
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          name: ${{ matrix.app.name }} Test Coverage
          json-summary-path: ./${{ matrix.app.directory }}/coverage-summary.json
          json-final-path: ./${{ matrix.app.directory }}/coverage.json

  upload-coverage:
    name: Upload Coverage to Codecov
    runs-on: ubuntu-latest
    needs: test
    if: always() && needs.test.result != 'skipped'
    steps:
      - name: Download Coverage Artifacts
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
      - name: Upload Reports
        uses: codecov/codecov-action@v5
        with:
          files: ./apps/web/coverage/lcov.info,./packages/ui/coverage/lcov.info
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}
